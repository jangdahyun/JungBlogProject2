<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
    <title>뉴스</title>
    <!-- font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap" rel="stylesheet">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- ChartJs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- UIkit CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.17.11/dist/css/uikit.min.css"/>
    <!-- UIkit JS -->
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.17.11/dist/js/uikit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.17.11/dist/js/uikit-icons.min.js"></script>
    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    
    <link rel="stylesheet" href="/css/mainHeader.css">
	<script src="/js/mainHeader.js"></script>
    
    <style type="text/css">
    	*{margin: 0; padding: 0; box-sizing: border-box;}
		a{text-decoration: none; color: inherit;}
		body {color: #fff;background: #302F2B;font-family: "Noto Sans KR", sans-serif;}
		main{ padding: 130px 0;width: 780px; margin: auto;}
		#title {color: #fff; font-weight: bold;}
		#newsContainer{border-top: 1px solid #e5e5e5; padding-top:20px ;color: #fff; display: flex;}
		.today{width: 110px; font-size: 16px; font-weight: bold; position: absolute; top:0;left: 0;}
		#itemBox{margin:0; padding: 0;}
		.item{
			display: flex;
			justify-content: space-between;
			position: relative;
			padding-left: 135px;
			margin-bottom: 20px;
		}
		.item a {
			color: #fff;
		}
		.textArea::before{
			content: '';
		    display: inline-block;
		    position: absolute;
		    top: 3px;
		    left: -20px;
		    width: 11px;
		    height: 11px;
		    border-radius: 100%;
		    background: #e5e5e5;
		}
		.textArea::after{
			content: '';
		    display: inline-block;
		    position: absolute;
		    top: 3px;
		    left: -15px;
		    width: 1px;
		    height: 130px;
		    background: #e5e5e5;
		}
		.textArea{
			width: calc(100% - 245px);
			position: relative;
		}
		.time{
			font-weight: bold;
			font-size: 14px;
		}
		.news-title{
			margin: 15px 0 10px;
			font-size: 20px;
			line-height: 25px;
		}
		.imgArea{
			position: relative;
			width: 110px;
			height: 110px;
			overflow: hidden;
			border-radius: 10px;
		}
		.imgArea .noImg{
			border: 1px solid #fff;
			border-radius: 10px;
		}
		.imgArea img{
			display: block;
			width: 100%;
		    height: 100%;
		    object-fit: cover;
		    object-position: center top;
		}
		.imgArea a {
			display: block;
			width: 100%;
			height: 100%;
		}
		
		#goTopBtn{
			width: 50px; height: 50px;
			background: rgba(0,0,0,0.5);
			position: fixed;
			right: 210px; bottom: 50px;
			border-radius: 100%;
			display: flex;
			align-items: center;
			justify-content: center;
			cursor: pointer;
		}
    </style>
</head>
<body>
	<input type="hidden" id="lastItemIdx" th:value="${lastItemIdx + 1}">
	<input type="hidden" id="categoryText" th:value="${category}">
	<div id="goTopBtn">
		<span class="material-symbols-outlined">expand_less</span>
	</div>
	
	<th:block th:insert="~{/mainHeader.html}"></th:block>
	
	<div id="main-wrap">
		<main>
			<h2 id="title">[[${title}]]</h2>
			<div style="display: flex; justify-content: end; align-items: center; margin-bottom: 10px;">
				<label style="margin-right:10px;">검색</label>
				<form action="" method="get">
					<div class="uk-inline">
			            <span class="uk-form-icon uk-form-icon-flip" uk-icon="icon: search"></span>
			            <input id="searchText" name="search" th:value="${search}" class="uk-input" type="text" autocomplete='off' aria-label="Not clickable icon" placeholder="검색어를 입력해주세요">
			        </div>
				</form>
			</div>
			<div id="newsContainer">
				<ul id="itemBox">
					
				</ul>
			</div>
		</main>
	</div>
	<script type="text/javascript">
		let search = undefined;
		let category = undefined;
		const sizeOfPage = 10;
		let lastItemIdx = 0;
		let today = "";
		
		
		
		function init(){
			lastItemIdx = document.querySelector("#lastItemIdx").value;
			category = document.querySelector("#categoryText").value;
			search = document.querySelector("#searchText").value;
			if(category.trim().length == 0){
				category = undefined;
			}
			if(search.trim().length == 0){
				search = undefined;
			}
			itemload();
		}
		
		function findLastItemIdx(){
			console.log('findLastItemIdx 실행', lastItemIdx);
			let items = document.querySelectorAll(".item");
			let lastItem = items[items.length - 1];
			let result = lastItem.querySelector(".idx").value;
			lastItemIdx = result;
			console.log('findLastItemIdx 리턴', lastItemIdx);
		}
		
		/** 데이터 읽기 */
		function itemload(){
			axios.post("/news/getNews", {
				"search" : search,
				"category" : category,
				"sizeOfPage" : sizeOfPage,
				"lastItemIdx" : lastItemIdx,
			})
			.then(res =>{
				const data = res.data;
				if(data.length == 0) {
					window.removeEventListener('scroll', scrollEvent);
					alert('더이상 글이 존재하지 않습니다.');
				}
				console.log(data);
				data.forEach(x => {
					updateTable(x)
				})
				findLastItemIdx();
			})
			.catch(e => {
				console.error("error :", e); 
			})
		}
		
		/** 데이터 뿌리기 */
		function updateTable(data){
			content = `
				<li class="item">
					<input type="hidden" class="idx" value="${data.idx}">
	                <div class="today">${todayRemove(extractDate(data.pubDate))}</div>
					<div class="textArea">
						<p class="time">${extractTime(data.pubDate)}</p>
						<h3 class="news-title">
							<a href="/news/view/${data.idx}">${data.title}</a>
						</h3>
					</div>
					<div class="imgArea">
			`;
			if(data.image == null){
				content += `
					<a href="/news/view/${data.idx}" class="noImg" style="display: flex; align-items: center; justify-content: center;">
						사진 없음
					</a>
				`
			} else {
				content += `
					<a href="/news/view/${data.idx}">
						<img src="${data.image}" alt="" />
					</a>
				`
			}
			content += `</div></li>`
			$("#itemBox").append(content);
		}
		
		function todayRemove(date){
	        let result = date;
			let currentDate = date;
	        if (currentDate == today) {
	            result = "";
	        } else {
	            today = currentDate;
	        }
	        return result;
		}
		
		// 스크롤 이벤트 리스너 추가
		window.addEventListener('scroll', scrollEvent);
		
		function scrollEvent(){
			let scrollPosition = window.scrollY;
		    let windowHeight = window.innerHeight;
		    let fullHeight = document.body.scrollHeight;
		    if (scrollPosition + windowHeight + 100>= fullHeight) {
		    	itemload();
		    }
		}
		
		function extractDate(date) {
		    return date.substr(0, 10);
		}
		function extractTime(date) {
		    return date.substr(11);
		}
		
		$(function(){
			init();
			
			$("#goTopBtn").click(function(){
				window.scrollTo({
			        top: 0,
			        behavior: 'smooth' // 부드러운 스크롤 효과 적용
			    });
			})
		})
		
	</script>
</body>
</html>
